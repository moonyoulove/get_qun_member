<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
</head>
<body>
<input type="checkbox"id="cbox_convert">
      轉換頭像網址<br>
<input type="checkbox" id="cbox_addTitle">
      加入專屬頭銜
	  <br>
<br>
<textarea name="TextEdit1" title="" cols="19" rows="8" id="textarea"></textarea><br>
<br>
<input name="Button1" type="button" value="獲取成員" title="" disabled="disabled" id="button">
<script type="text/javascript">
      var group = {};
      var pt = {};
      var logo_left_count = 0;
      var script = {};
      var cbox_convert = document.getElementById("cbox_convert");
      var cbox_addTitle = document.getElementById("cbox_addTitle");
      var textarea = document.getElementById("textarea");
      var button = document.getElementById("button");
      cbox_addTitle.onclick = function() {
        if (cbox_addTitle.checked) {
          textarea.defaultValue = '[{nick:"muli",title:"編程組"}]';
        } else {
          textarea.defaultValue = "";
        }
      }
      button.onclick = function() {
        if (cbox_addTitle.checked) addSpecialTitle();
        if (cbox_convert.checked) {
          convertLogoUrl();
        } else {
          textarea.value = JSON.stringify(group.mems);
        }
      }
      window.onmessage = function(e) {
        if (e.origin != "https://qun.qq.com") return;
        group = e.data;
        button.disabled = false;
      }
      pt.setHeader = function(url_data) {
        script.remove();
        group.mems[logo_left_count].logo = url_data[group.mems[logo_left_count].uin];
        if (logo_left_count > 0) {
          logo_left_count--;
          textarea.value = `剩餘${logo_left_count}個頭像`;
          script = document.createElement("script");
          script.src = logo_url + group.mems[logo_left_count].uin;
          document.body.appendChild(script);
        } else {
          textarea.value = JSON.stringify(group.mems);
        }
      }
      function addSpecialTitle() {
        group.mems.sort(function(a, b) {
          return a.join_time - b.join_time
        });
        if (textarea.value == "") {
          alert("請貼上數據!!");
          return;
        }
        var st = JSON.parse(textarea.value);
        var l = group.mems.length;
        while (l--) {
          group.mems[l].title = st[l].title;
        }
      }
      function convertLogoUrl() {
        logo_left_count = group.mems.length - 1;
        textarea.value = `剩餘$ {logo_left_count}個頭像`;
        script = document.createElement("script");
        script.src = logo_url + group.mems[logo_left_count].uin;
        document.body.appendChild(script);
      }
    </script>
</body>
</html>
